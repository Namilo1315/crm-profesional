<!DOCTYPE html> 
<html lang="es">
<head>  
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Savia ‚Äì CRM Salud ¬∑ Lic. Silvia Molina</title>
  <meta name="description" content="Mini CRM para la Lic. Silvia Molina: pacientes, historia cl√≠nica simple, agenda de turnos y recetas/certificados.">

  <!-- Favicon Savia -->
  <link rel="icon" type="image/png" href="img/logo_transparent_background.png">

  <!-- Tipograf√≠as Savia -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --verde-savia:#4BAF8C;
      --verde-claro:#A7E3CF;
      --turquesa:#14b8a6;
      --gris-fondo:#f5f7fa;
      --card:#ffffff;
      --borde:#dde5ee;
      --texto:#111827;
      --texto-suave:#6b7280;
      --peligro:#ef4444;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Poppins',system-ui,-apple-system,blinkmacsystemfont,"Segoe UI",sans-serif;
      background:var(--gris-fondo);
      color:var(--texto);
    }
    h1,h2,h3,h4{
      font-family:'Cormorant Garamond','Poppins',serif;
      letter-spacing:.02em;
      margin:0;
    }
    p{margin:0;}
    a{text-decoration:none;color:inherit;}

    /* ===== LAYOUT GENERAL ===== */
    .app-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      padding:14px 18px;
      background:#4BAF8C;
      color:white;
      box-shadow:0 10px 30px rgba(15,23,42,.22);
      position:sticky;
      top:0;
      z-index:30;
    }
    .header-inner{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:40px;
      height:40px;
      border-radius:14px;
      background:rgba(255,255,255,.95);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:0 8px 18px rgba(15,23,42,.25);
    }
    .brand-logo img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .brand-text h1{
      font-size:20px;
      line-height:1.1;
    }
    .brand-text span{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.18em;
      opacity:.9;
    }

    .header-cta{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      font-size:11px;
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(24,40,72,.20);
      backdrop-filter:blur(6px);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    /* Ocultar cartel Savia en celular */
    @media (max-width:768px){
      .header-cta{
        display:none;
      }
    }

    /* ===== TABS SECCIONES ===== */
    .top-tabs{
      padding:8px 16px 0;
    }
    .tabs-inner{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab-btn{
      border:none;
      background:#e0f7f1;
      color:#047857;
      border-radius:999px;
      padding:6px 14px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 4px 10px rgba(15,118,110,.12);
    }
    .tab-btn.active{
      background:#0f766e;
      color:#fff;
      box-shadow:0 8px 18px rgba(15,118,110,.35);
    }

    main{
      flex:1;
      padding:14px 16px 28px;
    }
    .main-inner{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* ===== KPIs ===== */
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      margin-top:8px;
    }
    .kpi-card{
      flex:1 1 180px;
      min-width:150px;
      background:var(--card);
      border-radius:20px;
      padding:12px 14px;
      box-shadow:0 14px 30px rgba(15,23,42,.06);
      border:1px solid var(--borde);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--texto-suave);
    }
    .kpi-value{
      font-size:22px;
      font-weight:600;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .kpi-chip{
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      background:#e0f7f1;
      color:#047857;
      text-transform:uppercase;
      letter-spacing:.14em;
    }

    /* ===== CONTROLES ===== */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:4px;
    }
    .toolbar-left,
    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .btn{
      border:none;
      font-family:inherit;
      font-size:12px;
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.15s ease;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--turquesa);
      color:#fff;
      box-shadow:0 10px 20px rgba(56,189,248,.35);
    }
    .btn-primary:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    .btn-outline{
      background:white;
      border:1px solid var(--borde);
      color:var(--texto-suave);
    }
    .btn-outline.active{
      border-color:var(--turquesa);
      color:var(--turquesa);
      background:#e0f7f1;
    }
    .btn-danger{
      background:var(--peligro);
      color:#fff;
    }
    .search-input{
      border-radius:999px;
      border:1px solid var(--borde);
      padding:7px 28px 7px 10px;
      font-size:12px;
      min-width:170px;
      outline:none;
      background:white url("data:image/svg+xml,%3Csvg width='18' height='18' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='11' cy='11' r='6' stroke='%2394a3b8' stroke-width='2'/%3E%3Cpath d='M16 16L20 20' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 6px center;
      background-size:16px;
    }
    .search-input:focus{
      border-color:var(--turquesa);
      box-shadow:0 0 0 1px rgba(34,197,94,.25);
    }

    /* ===== CONTENIDO PRINCIPAL (2 columnas) ===== */
    .content-row{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap:16px;
      align-items:flex-start;
      margin-top:6px;
    }
    @media(max-width:900px){
      .content-row{grid-template-columns:1fr;}
    }

    /* ===== PANEL GENERAL ===== */
    .panel{
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--borde);
      box-shadow:0 12px 28px rgba(15,23,42,.06);
      padding:10px 12px 12px;
      min-height:120px;
    }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .panel-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--texto-suave);
    }
    .panel-sub{
      font-size:11px;
      color:var(--texto-suave);
    }

    /* ===== LISTADO DE PACIENTES ===== */
    .clientes-list{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:420px;
      overflow:auto;
    }
    .cliente-item{
      border-radius:14px;
      border:1px solid transparent;
      padding:8px 9px;
      display:flex;
      gap:8px;
      align-items:flex-start;
      cursor:pointer;
      transition:.14s ease;
      background:#f9fafb;
    }
    .cliente-item:hover{
      background:#eef4ff;
      border-color:#d0e1ff;
    }
    .cliente-item.selected{
      border-color:var(--turquesa);
      background:#e0f7f1;
    }
    .cliente-avatar{
      width:30px;
      height:30px;
      border-radius:10px;
      background:linear-gradient(145deg,#22c55e,#14b8a6);
      color:#fff;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      font-weight:600;
    }
    .cliente-main{
      flex:1;
      min-width:0;
    }
    .cliente-top-row{
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:center;
    }
    .cliente-nombre{
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cliente-servicio{
      font-size:11px;
      color:var(--texto-suave);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cliente-meta{
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:10px;
      color:var(--texto-suave);
    }
    .badge{
      padding:2px 7px;
      border-radius:999px;
      background:#e5e7eb;
    }
    .empty-state{
      font-size:12px;
      color:var(--texto-suave);
      padding:14px 6px 6px;
      text-align:center;
    }

    /* ===== DETALLE PACIENTE ===== */
    .detalle-wrapper{display:flex;flex-direction:column;gap:10px;}
    .detalle-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .detalle-main{display:flex;flex-direction:column;gap:4px;}
    .detalle-nombre{font-size:18px;font-weight:600;}
    .detalle-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .detalle-meta-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:6px;
    }
    @media(max-width:600px){
      .detalle-meta-grid{grid-template-columns:1fr;}
    }
    .meta-item-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--texto-suave);
    }
    .meta-item-value{font-size:12px;margin-top:2px;}
    .detalle-section-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--texto-suave);
      margin-top:10px;
      margin-bottom:4px;
    }

    .visitas-list{
      list-style:none;
      padding:0;
      margin:0;
      max-height:220px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }
    .visita-item{
      border-radius:12px;
      padding:6px 8px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:flex-start;
    }
    .visita-left{display:flex;flex-direction:column;gap:2px;}
    .visita-monto{font-weight:600;}
    .visita-nota{font-size:11px;color:var(--texto-suave);}
    .nota-span{font-size:11px;color:var(--texto-suave);margin-top:4px;}

    /* ===== AGENDA / TURNOS ===== */
    .agenda-grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:12px;
      align-items:flex-start;
      margin-top:4px;
    }
    @media(max-width:900px){
      .agenda-grid{grid-template-columns:1fr;}
    }
    .turnos-list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:220px;
      overflow:auto;
      font-size:11px;
    }
    .turno-item{
      border-radius:12px;
      padding:4px 6px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:flex-start;
      font-size:11px;
    }
    .turno-item.atendido{
      background:#ecfdf3;
      border-color:#bbf7d0;
    }
    .turno-left{display:flex;flex-direction:column;gap:2px;}
    .turno-hora{font-weight:600;font-size:12px;}
    .turno-nombre{font-size:11px;}
    .turno-motivo{font-size:10px;color:var(--texto-suave);}
    .turno-fecha-peq{font-size:10px;color:var(--texto-suave);}
    .turno-actions{
      display:flex;
      flex-direction:column;
      gap:3px;
      align-items:flex-end;
    }
    .turno-actions button{
      border:none;
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      cursor:pointer;
    }
    .turno-actions .turno-wa{background:#dcfce7;color:#047857;}
    .turno-actions .turno-ok{background:#e0f2fe;color:#1d4ed8;}
    .turno-actions .turno-del{background:#fee2e2;color:#b91c1c;}

    .agenda-subtitle{
      font-size:11px;
      color:var(--texto-suave);
      margin-top:2px;
    }

    /* ===== RECETAS / CERTIFICADOS ===== */
    .doc-grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:12px;
      align-items:flex-start;
      margin-top:6px;
    }
    @media(max-width:900px){
      .doc-grid{grid-template-columns:1fr;}
    }
    .doc-col{display:flex;flex-direction:column;gap:8px;}
    .doc-preview{
      background:#f9fafb;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:10px;
      font-family:monospace;
      font-size:11px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* FIRMA DIGITAL */
    .firma-wrapper{
      background:#f9fafb;
      border-radius:12px;
      border:1px dashed #cbd5e1;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    #firma-canvas{
      width:100%;
      height:120px;
      background:#ffffff;
      border-radius:8px;
      border:1px solid #e5e7eb;
      touch-action:none;
    }
    .firma-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }

    /* ===== DASHBOARD ===== */
    .dash-resumen{
      font-size:12px;
      color:var(--texto-suave);
      margin-top:8px;
    }

    /* ===== MODALES ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.3);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:12px;
    }
    .modal-backdrop.open{display:flex;}
    .modal{
      max-width:420px;
      width:100%;
      background:var(--card);
      border-radius:18px;
      padding:14px 14px 16px;
      box-shadow:0 18px 50px rgba(15,23,42,.35);
      border:1px solid var(--borde);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .modal-title{font-size:15px;}
    .modal-body{display:flex;flex-direction:column;gap:8px;}
    .form-row{display:flex;flex-direction:column;gap:4px;}
    label{font-size:11px;color:var(--texto-suave);}
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea,
    select{
      border-radius:10px;
      border:1px solid var(--borde);
      padding:7px 9px;
      font-size:12px;
      font-family:inherit;
      outline:none;
      resize:vertical;
      min-height:32px;
      background:#fff;
      width:100%;
    }
    input:focus,textarea:focus,select:focus{
      border-color:var(--turquesa);
      box-shadow:0 0 0 1px rgba(34,197,94,.24);
    }
    textarea{min-height:54px;}
    .form-inline{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .form-inline > *{flex:1;}
    .modal-footer{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    /* Utilidades */
    .text-muted{color:var(--texto-suave);}
    .small{font-size:11px;}
    .mt-4{margin-top:4px;}
    .mt-6{margin-top:6px;}
    .mt-10{margin-top:10px;}

    /* Escala general de la p√°gina a 90 % en escritorio */
    html{
      zoom:0.9;              /* funciona en Chrome / Edge */
    }

    /* En celular dejamos el tama√±o normal para no romper el dise√±o */
    @media (max-width:768px){
      html{
        zoom:1;
      }
    }

    /* Header + layout m√°s c√≥modo en celular
       y FORMULARIOS / BOTONES acomodados */
    @media (max-width:600px){
      header{
        padding:12px 16px;
      }
      .header-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .brand-text h1{
        font-size:18px;
      }
      .brand-text span{
        font-size:10px;
      }

      /* KPIs una abajo de otra */
      .kpi-card{
        flex:1 1 100%;
      }

      /* Toolbar en columna, sin desbordes */
      .toolbar{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .toolbar-left,
      .toolbar-right{
        width:100%;
        justify-content:flex-start;
      }
      .toolbar-right{
        justify-content:stretch;
      }
      .search-input{
        width:100%;
        min-width:0;
      }

      /* Formularios: filas en columna */
      .form-inline{
        flex-direction:column;
        align-items:stretch;
      }

      /* Pies de formularios: botones en 2 columnas si hay muchos */
      .modal-footer{
        flex-wrap:wrap;
        justify-content:flex-end;
      }
      .modal-footer .btn{
        flex:1 1 calc(50% - 4px);
        justify-content:center;
      }
      /* En la columna de recetas que tiene muchos botones, alineados a la izquierda */
      .doc-col .modal-footer{
        justify-content:flex-start;
      }

      /* Firma: botones no tan pegados */
      .firma-actions{
        justify-content:flex-start;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo">
          <img src="img/logo_transparent_background.png" alt="Savia">
        </div>
        <div class="brand-text">
          <span>CRM salud</span>
          <h1>Lic. Silvia Molina ¬∑ Psic√≥loga</h1>
        </div>
      </div>

      <!-- Cartel Savia solo para escritorio -->
      <div class="header-cta">
        <div class="pill">
          <span>Savia</span>
          <span>Tu Agenda mas simple</span>
        </div>
      </div>
    </div>
  </header>

  <!-- TABS -->
  <nav class="top-tabs">
    <div class="tabs-inner">
      <button class="tab-btn active" data-section="inicio">Inicio</button>
      <button class="tab-btn" data-section="turnos">Turnos</button>
      <button class="tab-btn" data-section="recetas">Recetas / certificados</button>
      <button class="tab-btn" data-section="dashboard">Dashboard</button>
    </div>
  </nav>

  <main>
    <div class="main-inner">
      <!-- ============ SECCI√ìN INICIO ============ -->
      <section id="section-inicio">
        <!-- Turnos del d√≠a -->
        <section class="panel" id="panel-turnos-home">
          <div class="panel-header">
            <div>
              <div class="panel-title">Turnos del d√≠a</div>
              <div class="panel-sub">Resumen r√°pido de la agenda de hoy</div>
            </div>
          </div>
          <ul class="turnos-list" id="lista-turnos-home"></ul>
          <div id="agenda-empty-home" class="empty-state">
            Hoy no ten√©s turnos cargados.
          </div>
        </section>

        <!-- KPIs mini -->
        <section class="kpi-row" aria-label="Indicadores principales">
          <article class="kpi-card">
            <div class="kpi-label">Pacientes activos</div>
            <div class="kpi-value"><span id="kpi-total-clientes">0</span></div>
            <div class="kpi-chip">Mini CRM Savia Psicolog√≠a</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">Nuevos este mes</div>
            <div class="kpi-value"><span id="kpi-nuevos-mes">0</span></div>
            <div class="kpi-chip" id="kpi-mes-label">Mes actual</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">Turnos de hoy</div>
            <div class="kpi-value"><span id="kpi-turnos-hoy">0</span></div>
            <div class="kpi-chip">Agenda diaria</div>
          </article>
        </section>

        <!-- Toolbar -->
        <section class="toolbar">
          <div class="toolbar-left">
            <button class="btn btn-primary" id="btn-nuevo-cliente">+ Nuevo paciente</button>

            <button class="btn btn-outline active" data-filter="todos">Todos</button>
            <button class="btn btn-outline" data-filter="sin30">+30 d√≠as sin consulta</button>
            <button class="btn btn-outline" data-filter="nuevos">Nuevos este mes</button>
          </div>

          <div class="toolbar-right">
            <input type="text" id="buscador-clientes" class="search-input" placeholder="Buscar por nombre o motivo...">
            <button class="btn btn-outline" id="btn-reset-demo" title="Borrar datos de ejemplo">Borrar datos demo</button>
          </div>
        </section>

        <!-- Pacientes + Detalle -->
        <section class="content-row">
          <!-- LISTA PACIENTES -->
          <section class="panel" aria-label="Listado de pacientes">
            <div class="panel-header">
              <div>
                <div class="panel-title">Pacientes</div>
                <div class="panel-sub" id="subtitulo-lista">0 pacientes</div>
              </div>
            </div>
            <ul id="lista-clientes" class="clientes-list"></ul>
            <div id="empty-lista" class="empty-state" style="display:none;">
              Todav√≠a no cargaste pacientes. Us√° el bot√≥n <strong>‚ÄúNuevo paciente‚Äù</strong> para empezar.
            </div>
          </section>

          <!-- DETALLE PACIENTE -->
          <section class="panel" aria-label="Detalle del paciente seleccionado">
            <div class="panel-header">
              <div>
                <div class="panel-title">Detalle de paciente</div>
                <div class="panel-sub">Ficha b√°sica</div>
              </div>
            </div>

            <div id="detalle-contenido" class="detalle-wrapper">
              <div class="empty-state" id="detalle-empty">
                Seleccion√° un paciente de la lista para ver su ficha.
              </div>

              <div id="detalle-completo" style="display:none;">
                <div class="detalle-header">
                  <div class="detalle-main">
                    <div class="detalle-nombre" id="detalle-nombre">Nombre</div>
                    <div class="detalle-tags" id="detalle-tags"></div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:6px;">
                    <button class="btn btn-outline" id="btn-editar-cliente">Editar datos</button>
                    <button class="btn btn-danger" id="btn-eliminar-cliente">Eliminar</button>
                  </div>
                </div>

                <div class="detalle-meta-grid mt-6">
                  <div>
                    <div class="meta-item-label">WhatsApp</div>
                    <div class="meta-item-value">
                      <span id="detalle-whatsapp"></span><br>
                      <button class="btn btn-outline mt-4" id="btn-whatsapp" style="padding:4px 8px;font-size:11px;">
                        üí¨ Escribir por WhatsApp
                      </button>
                    </div>
                  </div>
                  <div>
                    <div class="meta-item-label">Obra social / forma de pago</div>
                    <div class="meta-item-value" id="detalle-cobertura">‚Äî</div>
                  </div>
                  <div>
                    <div class="meta-item-label">Motivo / tipo de atenci√≥n</div>
                    <div class="meta-item-value" id="detalle-servicio">‚Äî</div>
                  </div>
                </div>

                <div class="detalle-section-title">Notas / observaciones generales</div>
                <div class="nota-span" id="detalle-notas">Sin notas cargadas.</div>

                <!-- Bloque de historia cl√≠nica / registrar consultas OCULTO para que ya no aparezca en la UI -->
                <div id="historia-clinica-wrapper" style="display:none;">
                  <div class="detalle-section-title">Historia cl√≠nica / sesiones</div>
                  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:4px;">
                    <span class="small text-muted">Uso interno. No reemplaza la historia cl√≠nica oficial de tu sistema.</span>
                    <button class="btn btn-outline" id="btn-nueva-visita" style="padding:4px 8px;font-size:11px;">+ Registrar consulta</button>
                  </div>

                  <ul class="visitas-list" id="lista-visitas"></ul>
                  <div class="empty-state" id="visitas-empty" style="margin-top:4px;">
                    Todav√≠a no registraste consultas. Empez√° con el bot√≥n ‚ÄúRegistrar consulta‚Äù.
                  </div>
                </div>
              </div>
            </div>
          </section>
        </section>
      </section>

      <!-- ============ SECCI√ìN TURNOS ============ -->
      <section id="section-turnos" style="display:none;">
        <section class="panel" id="panel-agenda">
          <div class="panel-header">
            <div>
              <div class="panel-title">Agenda de turnos</div>
              <div class="panel-sub">
                Hoy ten√©s <strong id="agenda-hoy-count">0</strong> turno(s) agendados.
              </div>
            </div>
          </div>

          <div class="agenda-grid">
            <!-- Alta de turno -->
            <div>
              <div class="detalle-section-title">Nuevo turno</div>
              <form id="form-turno">
                <div class="form-inline">
                  <div class="form-row">
                    <label for="turno-fecha">Fecha</label>
                    <input type="date" id="turno-fecha">
                  </div>
                  <div class="form-row">
                    <label for="turno-hora">Hora</label>
                    <input type="time" id="turno-hora">
                  </div>
                </div>
                <div class="form-row">
                  <label for="turno-paciente-select">Paciente (si ya est√° cargado)</label>
                  <select id="turno-paciente-select">
                    <option value="">Seleccionar paciente...</option>
                  </select>
                </div>
                <div class="form-row">
                  <label for="turno-motivo">Motivo / nota del turno</label>
                  <input type="text" id="turno-motivo" placeholder="Ej: sesi√≥n, control, seguimiento, etc.">
                </div>
                <div class="modal-footer" style="justify-content:flex-start;margin-top:8px;">
                  <button type="submit" class="btn btn-primary">Guardar turno</button>
                </div>
              </form>
              <p class="agenda-subtitle">Pod√©s usarlo s√≥lo para recordar horarios diarios. Todo queda guardado en este dispositivo.</p>
            </div>

            <!-- Listas de turnos -->
            <div>
              <div class="detalle-section-title">Turnos de hoy</div>
              <ul class="turnos-list" id="lista-turnos-hoy"></ul>
              <div id="agenda-empty-hoy" class="empty-state" style="margin-top:4px;">
                Hoy no ten√©s turnos cargados.
              </div>

              <div class="detalle-section-title" style="margin-top:10px;">Pr√≥ximos turnos</div>
              <ul class="turnos-list" id="lista-turnos-prox"></ul>
              <div id="agenda-empty-prox" class="empty-state" style="margin-top:4px;">
                No hay turnos pr√≥ximos registrados.
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- ============ SECCI√ìN RECETAS / CERTIFICADOS ============ -->
      <section id="section-recetas" style="display:none;">
        <section class="panel" id="panel-documentos">
          <div class="panel-header">
            <div>
              <div class="panel-title">Recetas y certificados</div>
              <div class="panel-sub">Plantilla pensada para la Lic. Silvia Molina (Savia).</div>
            </div>
          </div>

          <div class="doc-grid">
            <!-- Col izquierda: profesional + doc + firma -->
            <div class="doc-col">
              <div class="detalle-section-title">Datos del profesional</div>
              <div class="form-inline">
                <div class="form-row">
                  <label for="medico-nombre">Nombre completo *</label>
                  <input type="text" id="medico-nombre" placeholder="Ej: Lic. Silvia Molina">
                </div>
                <div class="form-row">
                  <label for="medico-matricula">Matr√≠cula / MP</label>
                  <input type="text" id="medico-matricula" placeholder="Ej: MP 0000">
                </div>
              </div>
              <div class="form-row">
                <label for="medico-especialidad">Especialidad</label>
                <input type="text" id="medico-especialidad" placeholder="Ej: Psic√≥loga">
              </div>

              <div class="detalle-section-title">Firma digital del profesional</div>
              <div class="firma-wrapper">
                <canvas id="firma-canvas"></canvas>
                <div class="firma-actions">
                  <button type="button" class="btn btn-outline" id="btn-firma-limpiar">Borrar firma</button>
                  <button type="button" class="btn btn-outline" id="btn-firma-guardar">Guardar firma</button>
                </div>
                <span class="small text-muted">Dibuj√° tu firma con el mouse o el dedo (en celular). Se usar√° en los PDF a la derecha, con tu matr√≠cula debajo.</span>
              </div>

              <div class="detalle-section-title">Documento</div>
              <div class="form-row">
                <label for="doc-tipo">Tipo de documento</label>
                <select id="doc-tipo">
                  <option value="receta">Receta / Pedido</option>
                  <option value="certificado">Certificado m√©dico</option>
                </select>
              </div>
              <div class="form-row">
                <label for="doc-paciente-select">Paciente (si ya est√° en el CRM)</label>
                <select id="doc-paciente-select">
                  <option value="">Seleccionar paciente...</option>
                </select>
              </div>
              <div class="form-row">
                <label for="doc-paciente-nombre">Nombre del paciente</label>
                <input type="text" id="doc-paciente-nombre" placeholder="Ej: Juan P√©rez">
              </div>
              <div class="form-row">
                <label for="doc-obra-social">Obra social / cobertura</label>
                <input type="text" id="doc-obra-social" placeholder="Ej: OSEP, OSDE, Particular, etc.">
              </div>
              <div class="form-row">
                <label for="doc-whatsapp">WhatsApp del paciente (para abrir el chat)</label>
                <input type="tel" id="doc-whatsapp" placeholder="Ej: 2613387305">
              </div>
              <div class="form-row">
                <label for="doc-cuerpo">Texto del documento</label>
                <textarea id="doc-cuerpo" placeholder="Escrib√≠ aqu√≠ la indicaci√≥n, pedido o el texto del certificado."></textarea>
              </div>

              <div class="modal-footer" style="justify-content:flex-start;margin-top:8px;">
                <button class="btn btn-primary" type="button" id="btn-doc-pdf">Generar PDF</button>
                <button class="btn btn-outline" type="button" id="btn-doc-copiar">Copiar texto</button>
                <button class="btn btn-outline" type="button" id="btn-doc-whatsapp">Abrir WhatsApp</button>
                <button class="btn btn-outline" type="button" id="btn-doc-limpiar">Salir (limpiar)</button>
              </div>
              <span class="small text-muted">
                Documento orientativo. Revis√° las normas de tu colegio profesional sobre recetas y certificados digitales.
              </span>
            </div>

            <!-- Col derecha: vista previa + historial -->
            <div class="doc-col">
              <div class="detalle-section-title">Vista previa r√°pida</div>
              <pre id="doc-preview" class="doc-preview"></pre>

              <!-- El historial de "√∫ltimos documentos" queda oculto visualmente -->
              <div id="doc-historial-wrapper" style="display:none;">
                <div class="detalle-section-title">√öltimos documentos</div>
                <ul id="doc-historial" class="visitas-list"></ul>
                <div id="doc-empty" class="empty-state" style="margin-top:4px;">
                  Todav√≠a no generaste recetas o certificados.
                </div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- ============ SECCI√ìN DASHBOARD ============ -->
      <section id="section-dashboard" style="display:none;">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">Dashboard general</div>
              <div class="panel-sub">Resumen de pacientes y turnos en Savia.</div>
            </div>
          </div>

          <section class="kpi-row">
            <article class="kpi-card">
              <div class="kpi-label">Pacientes activos</div>
              <div class="kpi-value"><span id="dash-total-clientes">0</span></div>
            </article>
            <article class="kpi-card">
              <div class="kpi-label">Nuevos este mes</div>
              <div class="kpi-value"><span id="dash-nuevos-mes">0</span></div>
              <div class="kpi-chip" id="dash-mes-label">Mes actual</div>
            </article>
            <article class="kpi-card">
              <div class="kpi-label">Turnos de hoy</div>
              <div class="kpi-value"><span id="dash-turnos-hoy">0</span></div>
            </article>
          </section>

          <p class="dash-resumen" id="dash-resumen"></p>
        </section>
      </section>
    </div>
  </main>
</div>

<!-- MODAL NUEVO / EDITAR PACIENTE -->
<div class="modal-backdrop" id="modal-cliente-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modal-cliente-titulo">Nuevo paciente</div>
        <div class="small text-muted">Guard√° datos b√°sicos para tener la ficha siempre a mano.</div>
      </div>
      <button class="btn btn-outline" id="cerrar-modal-cliente">‚úï</button>
    </div>
    <form id="form-cliente">
      <div class="modal-body">
        <input type="hidden" id="cliente-id">
        <div class="form-row">
          <label for="cliente-nombre">Nombre y apellido *</label>
          <input type="text" id="cliente-nombre" required placeholder="Ej: Juan P√©rez">
        </div>
        <div class="form-row">
          <label for="cliente-servicio">Motivo de consulta / tipo de atenci√≥n</label>
          <input type="text" id="cliente-servicio" placeholder="Ej: psicoterapia, control, etc.">
        </div>
        <div class="form-row">
          <label for="cliente-cobertura">Obra social / forma de pago</label>
          <input type="text" id="cliente-cobertura" placeholder="Ej: OSEP, OSDE, Particular, etc.">
        </div>
        <div class="form-inline">
          <div class="form-row">
            <label for="cliente-whatsapp">WhatsApp (solo n√∫meros)</label>
            <input type="tel" id="cliente-whatsapp" placeholder="Ej: 2613387305">
          </div>
          <div class="form-row">
            <label for="cliente-email">Email</label>
            <input type="email" id="cliente-email" placeholder="Ej: paciente@mail.com">
          </div>
        </div>
        <div class="form-row">
          <label for="cliente-notas">Notas / observaciones generales</label>
          <textarea id="cliente-notas" placeholder="Ej: prefiere consultas por la tarde, datos relevantes que quieras recordar."></textarea>
        </div>
        <span class="small text-muted">No registres aqu√≠ datos excesivamente sensibles si tu pr√°ctica requiere otra historia cl√≠nica.</span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="cancelar-modal-cliente">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="guardar-cliente">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL NUEVA CONSULTA (se mantiene pero el bloque visual est√° oculto en el detalle) -->
<div class="modal-backdrop" id="modal-visita-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div>
        <div class="modal-title">Registrar consulta</div>
        <div class="small text-muted">Carg√° la consulta para actualizar la historia cl√≠nica y los indicadores.</div>
      </div>
      <button class="btn btn-outline" id="cerrar-modal-visita">‚úï</button>
    </div>
    <form id="form-visita">
      <div class="modal-body">
        <div class="form-inline">
          <div class="form-row">
            <label for="visita-fecha">Fecha</label>
            <input type="date" id="visita-fecha">
          </div>
          <div class="form-row">
            <label for="visita-monto">Monto ($)</label>
            <input type="number" id="visita-monto" min="0" step="1000" placeholder="Ej: 15000">
          </div>
        </div>
        <div class="form-row">
          <label for="visita-nota">Detalle / notas de la sesi√≥n</label>
          <textarea id="visita-nota" placeholder="Escrib√≠ un resumen de la sesi√≥n o control."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="cancelar-modal-visita">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar consulta</button>
      </div>
    </form>
  </div>
</div>

<!-- jsPDF para PDF de recetas/certificados -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const STORAGE_KEY = 'savia_crm_silvia';

  let appState = {
    clientes: [],
    turnos: [],
    documentos: [],
    medico: {}
  };
  let selectedClientId = null;
  let currentFilter = 'todos';
  let currentSearch = '';

  let firmaCanvas = null;
  let firmaCtx = null;
  let firmaDrawing = false;
  let firmaLastX = 0;
  let firmaLastY = 0;

  // ====== ESTADO Y LOCALSTORAGE ======
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      seedDemoData();
      return;
    }
    try{
      appState = JSON.parse(raw) || {};
      if(!appState.clientes) appState.clientes = [];
      if(!appState.turnos) appState.turnos = [];
      if(!appState.documentos) appState.documentos = [];
      if(!appState.medico) appState.medico = {};
    }catch(e){
      console.warn('Error al leer localStorage, se reinicia.', e);
      seedDemoData();
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
  }

  // Datos demo: 10 pacientes para probar el scroll
  function seedDemoData(){
    const hoy = new Date();
    const iso = d => d.toISOString().slice(0,10);

    const d1 = new Date(hoy);
    d1.setDate(hoy.getDate()-5);

    const d2 = new Date(hoy);
    d2.setDate(hoy.getDate()-40);

    const d3 = new Date(hoy);
    d3.setMonth(hoy.getMonth()-2);

    const d4 = new Date(hoy);
    d4.setDate(hoy.getDate()-15);

    const d5 = new Date(hoy);
    d5.setMonth(hoy.getMonth()-1);

    const hoyIso = iso(hoy);

    appState = {
      clientes:[
        {
          id:'c1',
          nombre:'Carla G√≥mez',
          servicioPrincipal:'Psicoterapia individual',
          cobertura:'Particular',
          whatsapp:'2613387305',
          email:'carla@example.com',
          fechaAlta:iso(d3),
          ultimaVisita:iso(d1),
          notas:'Viene cada 15 d√≠as. Prefiere turnos despu√©s de las 18 hs.',
          visitas:[
            {id:'v1',fecha:iso(d3),monto:15000,nota:'Primera entrevista.'},
            {id:'v2',fecha:iso(d1),monto:15000,nota:'Segunda sesi√≥n.'}
          ]
        },
        {
          id:'c2',
          nombre:'Mariano L√≥pez',
          servicioPrincipal:'Proceso terap√©utico',
          cobertura:'OSEP',
          whatsapp:'2614001122',
          email:'',
          fechaAlta:iso(d1),
          ultimaVisita:iso(d1),
          notas:'Metas: manejo de ansiedad.',
          visitas:[
            {id:'v3',fecha:iso(d1),monto:12000,nota:'Evaluaci√≥n inicial.'}
          ]
        },
        {
          id:'c3',
          nombre:'Luc√≠a Fern√°ndez',
          servicioPrincipal:'Acompa√±amiento psicol√≥gico',
          cobertura:'OSDE',
          whatsapp:'2615002233',
          email:'lucia@example.com',
          fechaAlta:iso(d2),
          ultimaVisita:iso(d2),
          notas:'Seguimiento mensual.',
          visitas:[
            {id:'v4',fecha:iso(d2),monto:10000,nota:'Sesi√≥n de seguimiento.'}
          ]
        },
        {
          id:'c4',
          nombre:'Juan P√©rez',
          servicioPrincipal:'Psicoterapia individual',
          cobertura:'Particular',
          whatsapp:'2613111111',
          email:'juan@example.com',
          fechaAlta:iso(d4),
          ultimaVisita:iso(d4),
          notas:'Trabaja en turnos rotativos.',
          visitas:[]
        },
        {
          id:'c5',
          nombre:'Ana Rodr√≠guez',
          servicioPrincipal:'Orientaci√≥n a padres',
          cobertura:'OSEP',
          whatsapp:'2613222222',
          email:'',
          fechaAlta:iso(d5),
          ultimaVisita:iso(d5),
          notas:'Padres separados, coordinaci√≥n de horarios.',
          visitas:[]
        },
        {
          id:'c6',
          nombre:'Diego Mart√≠nez',
          servicioPrincipal:'Evaluaci√≥n psicol√≥gica',
          cobertura:'Particular',
          whatsapp:'2613333333',
          email:'diego@example.com',
          fechaAlta:iso(d3),
          ultimaVisita:iso(d3),
          notas:'Proceso de evaluaci√≥n laboral.',
          visitas:[]
        },
        {
          id:'c7',
          nombre:'Valeria Su√°rez',
          servicioPrincipal:'Psicoterapia individual',
          cobertura:'OSDE',
          whatsapp:'2613444444',
          email:'valeria@example.com',
          fechaAlta:iso(d2),
          ultimaVisita:iso(d1),
          notas:'Ansiedad y estr√©s laboral.',
          visitas:[]
        },
        {
          id:'c8',
          nombre:'Natalia Herrera',
          servicioPrincipal:'Acompa√±amiento terap√©utico',
          cobertura:'Particular',
          whatsapp:'2613555555',
          email:'',
          fechaAlta:iso(d1),
          ultimaVisita:iso(d1),
          notas:'Trabaja con acompa√±ante terap√©utica externa.',
          visitas:[]
        },
        {
          id:'c9',
          nombre:'Sof√≠a Ortiz',
          servicioPrincipal:'Terapia breve',
          cobertura:'PAMI',
          whatsapp:'2613666666',
          email:'sofia@example.com',
          fechaAlta:hoyIso,
          ultimaVisita:hoyIso,
          notas:'Comenz√≥ proceso este mes.',
          visitas:[]
        },
        {
          id:'c10',
          nombre:'Pablo Torres',
          servicioPrincipal:'Seguimiento post alta',
          cobertura:'Particular',
          whatsapp:'2613777777',
          email:'pablo@example.com',
          fechaAlta:iso(d5),
          ultimaVisita:iso(d4),
          notas:'Sesiones quincenales.',
          visitas:[]
        }
      ],
      turnos:[
        {id:'t1',fecha:hoyIso,hora:'10:00',pacienteId:'c1',nombrePaciente:'Carla G√≥mez',motivo:'Sesi√≥n individual',atendido:false},
        {id:'t2',fecha:hoyIso,hora:'18:30',pacienteId:'c2',nombrePaciente:'Mariano L√≥pez',motivo:'Proceso terap√©utico',atendido:false},
        {id:'t3',fecha:iso(d1),hora:'09:00',pacienteId:'c3',nombrePaciente:'Luc√≠a Fern√°ndez',motivo:'Seguimiento',atendido:true}
      ],
      documentos:[],
      medico:{
        nombre:'Lic. Silvia Molina',
        matricula:'MP 0000',
        especialidad:'Psic√≥loga',
        firmaDataUrl:''
      }
    };
    saveState();
  }

  // ====== UTILIDADES ======
  function formatDate(iso){
    if(!iso) return '‚Äî';
    const d = new Date(iso + 'T00:00:00');
    if(isNaN(d)) return iso;
    return d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
  }

  function formatMoney(num){
    if(!num) return '$0';
    return '$' + num.toLocaleString('es-AR');
  }

  function daysDiffFromToday(iso){
    if(!iso) return null;
    const d = new Date(iso + 'T00:00:00');
    const hoy = new Date();
    const diffMs = hoy - d;
    return Math.floor(diffMs / (1000*60*60*24));
  }

  function sanitizePhone(phone){
    if(!phone) return '';
    return phone.replace(/[^\d]/g,'');
  }

  function getPacienteById(id){
    return (appState.clientes || []).find(c => c.id === id);
  }

  function calcularMetricas(){
    const clientes = appState.clientes || [];
    const hoy = new Date();
    const hoyIso = hoy.toISOString().slice(0,10);
    const mesActual = hoy.getMonth();
    const anioActual = hoy.getFullYear();

    let nuevosMes = 0;

    clientes.forEach(c => {
      if(c.fechaAlta){
        const d = new Date(c.fechaAlta+'T00:00:00');
        if(d.getMonth()===mesActual && d.getFullYear()===anioActual){
          nuevosMes++;
        }
      }
    });

    const turnos = appState.turnos || [];
    const turnosHoy = turnos.filter(t => t.fecha === hoyIso).length;

    return {
      totalClientes: clientes.length,
      nuevosMes,
      turnosHoy,
      mesActual,
      anioActual
    };
  }

  function updateDashboard(metrics){
    const totElem = document.getElementById('dash-total-clientes');
    if(!totElem) return;

    document.getElementById('dash-total-clientes').textContent = metrics.totalClientes;
    document.getElementById('dash-nuevos-mes').textContent = metrics.nuevosMes;
    document.getElementById('dash-turnos-hoy').textContent = metrics.turnosHoy;

    const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const mesTexto = meses[metrics.mesActual] + ' ' + metrics.anioActual;
    document.getElementById('dash-mes-label').textContent = mesTexto;

    const resumenElem = document.getElementById('dash-resumen');
    if(resumenElem){
      resumenElem.textContent =
        `Ten√©s ${metrics.totalClientes} pacientes activos y ${metrics.nuevosMes} nuevos este mes. ` +
        `Hoy ten√©s ${metrics.turnosHoy} turno(s) en la agenda.`;
    }
  }

  // ====== KPIs ======
  function renderKPIs(){
    const metrics = calcularMetricas();

    document.getElementById('kpi-total-clientes').textContent = metrics.totalClientes;
    document.getElementById('kpi-nuevos-mes').textContent = metrics.nuevosMes;
    document.getElementById('kpi-turnos-hoy').textContent = metrics.turnosHoy;

    const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    document.getElementById('kpi-mes-label').textContent = meses[metrics.mesActual] + ' ' + metrics.anioActual;

    document.getElementById('agenda-hoy-count').textContent = metrics.turnosHoy;

    updateDashboard(metrics);
  }

  // ====== FILTROS / BUSCADOR PACIENTES ======
  function applyFilterAndSearch(){
    let clientes = appState.clientes || [];
    const hoy = new Date();
    const mesActual = hoy.getMonth();
    const anioActual = hoy.getFullYear();

    if(currentFilter === 'sin30'){
      clientes = clientes.filter(c => {
        const d = daysDiffFromToday(c.ultimaVisita);
        return d !== null && d > 30;
      });
    } else if(currentFilter === 'nuevos'){
      clientes = clientes.filter(c => {
        if(!c.fechaAlta) return false;
        const d = new Date(c.fechaAlta+'T00:00:00');
        return d.getMonth()===mesActual && d.getFullYear()===anioActual;
      });
    }

    if(currentSearch.trim()!==''){
      const q = currentSearch.trim().toLowerCase();
      clientes = clientes.filter(c =>
        (c.nombre || '').toLowerCase().includes(q) ||
        (c.servicioPrincipal || '').toLowerCase().includes(q)
      );
    }

    return clientes;
  }

  // ====== LISTA PACIENTES ======
  function renderListaClientes(){
    const lista = document.getElementById('lista-clientes');
    const empty = document.getElementById('empty-lista');
    const subtitulo = document.getElementById('subtitulo-lista');

    const clientesFiltrados = applyFilterAndSearch();
    lista.innerHTML = '';

    if(clientesFiltrados.length === 0){
      empty.style.display = 'block';
      subtitulo.textContent = '0 pacientes';
    }else{
      empty.style.display = 'none';
      subtitulo.textContent = clientesFiltrados.length + ' paciente(s) mostrados';
    }

    clientesFiltrados.forEach(c => {
      const li = document.createElement('li');
      li.className = 'cliente-item' + (c.id === selectedClientId ? ' selected' : '');
      li.dataset.id = c.id;

      const avatar = document.createElement('div');
      avatar.className = 'cliente-avatar';
      avatar.textContent = (c.nombre || '?').trim().charAt(0).toUpperCase();

      const main = document.createElement('div');
      main.className = 'cliente-main';

      const topRow = document.createElement('div');
      topRow.className = 'cliente-top-row';

      const nombre = document.createElement('div');
      nombre.className = 'cliente-nombre';
      nombre.textContent = c.nombre || '(Sin nombre)';

      const servicio = document.createElement('div');
      servicio.className = 'cliente-servicio';
      servicio.textContent = c.servicioPrincipal || '‚Äî';

      topRow.appendChild(nombre);
      topRow.appendChild(servicio);

      const meta = document.createElement('div');
      meta.className = 'cliente-meta';

      if(c.whatsapp){
        const b = document.createElement('span');
        b.className = 'badge';
        b.textContent = 'WhatsApp: ' + c.whatsapp;
        meta.appendChild(b);
      }

      const ultima = document.createElement('span');
      ultima.className = 'badge';
      const diff = daysDiffFromToday(c.ultimaVisita);
      if(diff === null){
        ultima.textContent = 'Sin consultas a√∫n';
      }else{
        ultima.textContent = 'Hace ' + diff + ' d√≠a(s) de la √∫ltima consulta';
      }
      meta.appendChild(ultima);

      main.appendChild(topRow);
      main.appendChild(meta);

      li.appendChild(avatar);
      li.appendChild(main);

      li.addEventListener('click', () => {
        selectedClientId = c.id;
        renderListaClientes();
        renderDetalleCliente();
      });

      lista.appendChild(li);
    });

    renderDocPacienteOpciones();
  }

  // ====== DETALLE PACIENTE ======
  function renderDetalleCliente(){
    const empty = document.getElementById('detalle-empty');
    const completo = document.getElementById('detalle-completo');

    const cliente = (appState.clientes || []).find(c => c.id === selectedClientId);

    if(!cliente){
      empty.style.display = 'block';
      completo.style.display = 'none';
      return;
    }

    empty.style.display = 'none';
    completo.style.display = 'block';

    document.getElementById('detalle-nombre').textContent = cliente.nombre || '(Sin nombre)';

    const tags = document.getElementById('detalle-tags');
    tags.innerHTML = '';
    if(cliente.email){
      const em = document.createElement('span');
      em.className = 'badge';
      em.textContent = 'üìß ' + cliente.email;
      tags.appendChild(em);
    }
    if(cliente.cobertura){
      const cob = document.createElement('span');
      cob.className = 'badge';
      cob.textContent = 'Cobertura: ' + cliente.cobertura;
      tags.appendChild(cob);
    }
    if(cliente.ultimaVisita){
      const ult = document.createElement('span');
      ult.className = 'badge';
      ult.textContent = '√öltima consulta: ' + formatDate(cliente.ultimaVisita);
      tags.appendChild(ult);
    }

    document.getElementById('detalle-whatsapp').textContent = cliente.whatsapp || 'No cargado';
    document.getElementById('detalle-servicio').textContent = cliente.servicioPrincipal || '‚Äî';
    document.getElementById('detalle-cobertura').textContent = cliente.cobertura || '‚Äî';
    document.getElementById('detalle-notas').textContent = cliente.notas || 'Sin notas cargadas.';

    // Historial de consultas (queda oculto en la UI principal)
    const listaVisitas = document.getElementById('lista-visitas');
    const vacioVisitas = document.getElementById('visitas-empty');
    if(listaVisitas && vacioVisitas){
      listaVisitas.innerHTML = '';

      const visitas = cliente.visitas || [];
      if(visitas.length === 0){
        vacioVisitas.style.display = 'block';
      }else{
        vacioVisitas.style.display = 'none';
      }

      visitas
        .slice()
        .sort((a,b)=> (a.fecha || '').localeCompare(b.fecha || ''))
        .reverse()
        .forEach(v => {
          const li = document.createElement('li');
          li.className = 'visita-item';

          const left = document.createElement('div');
          left.className = 'visita-left';

          const fecha = document.createElement('div');
          fecha.textContent = formatDate(v.fecha);

          const nota = document.createElement('div');
          nota.className = 'visita-nota';
          nota.textContent = v.nota || 'Sin detalle.';

          left.appendChild(fecha);
          left.appendChild(nota);

          const monto = document.createElement('div');
          monto.className = 'visita-monto';
          monto.textContent = formatMoney(Number(v.monto || 0));

          li.appendChild(left);
          li.appendChild(monto);
          listaVisitas.appendChild(li);
        });
    }
  }

  // ====== MODALES ======
  const modalClienteBackdrop = document.getElementById('modal-cliente-backdrop');
  const modalVisitaBackdrop = document.getElementById('modal-visita-backdrop');

  function openModalCliente(modo){
    modalClienteBackdrop.classList.add('open');
    document.getElementById('modal-cliente-titulo').textContent =
      modo === 'editar' ? 'Editar paciente' : 'Nuevo paciente';
  }
  function closeModalCliente(){
    modalClienteBackdrop.classList.remove('open');
  }
  function openModalVisita(){
    if(!selectedClientId) return;
    const inputFecha = document.getElementById('visita-fecha');
    const hoyIso = new Date().toISOString().slice(0,10);
    inputFecha.value = hoyIso;

    document.getElementById('visita-monto').value = '';
    document.getElementById('visita-nota').value = '';

    modalVisitaBackdrop.classList.add('open');
  }
  function closeModalVisita(){
    modalVisitaBackdrop.classList.remove('open');
  }

  // ====== FORM PACIENTE ======
  function limpiarFormularioCliente(){
    document.getElementById('cliente-id').value = '';
    document.getElementById('cliente-nombre').value = '';
    document.getElementById('cliente-servicio').value = '';
    document.getElementById('cliente-cobertura').value = '';
    document.getElementById('cliente-whatsapp').value = '';
    document.getElementById('cliente-email').value = '';
    document.getElementById('cliente-notas').value = '';
  }

  function cargarFormularioCliente(cliente){
    document.getElementById('cliente-id').value = cliente.id;
    document.getElementById('cliente-nombre').value = cliente.nombre || '';
    document.getElementById('cliente-servicio').value = cliente.servicioPrincipal || '';
    document.getElementById('cliente-cobertura').value = cliente.cobertura || '';
    document.getElementById('cliente-whatsapp').value = cliente.whatsapp || '';
    document.getElementById('cliente-email').value = cliente.email || '';
    document.getElementById('cliente-notas').value = cliente.notas || '';
  }

  function eliminarCliente(){
    if(!selectedClientId) return;
    const cliente = (appState.clientes || []).find(c => c.id === selectedClientId);
    if(!cliente) return;

    const ok = confirm('¬øEliminar a "' + (cliente.nombre || '') + '" y todo su historial de consultas?');
    if(!ok) return;

    appState.clientes = (appState.clientes || []).filter(c => c.id !== selectedClientId);
    selectedClientId = null;
    saveState();
    renderKPIs();
    renderListaClientes();
    renderDetalleCliente();
    renderAgenda();
    renderTurnosHome();
  }

  // ====== NUEVA CONSULTA ======
  function guardarVisita(e){
    e.preventDefault();
    if(!selectedClientId) return;

    const cliente = (appState.clientes || []).find(c => c.id === selectedClientId);
    if(!cliente) return;

    const fecha = document.getElementById('visita-fecha').value || new Date().toISOString().slice(0,10);
    const monto = Number(document.getElementById('visita-monto').value || 0);
    const nota = document.getElementById('visita-nota').value || '';

    const visita = {
      id:'v_'+Date.now(),
      fecha,
      monto,
      nota
    };

    cliente.visitas = cliente.visitas || [];
    cliente.visitas.push(visita);
    cliente.ultimaVisita = fecha;

    saveState();
    closeModalVisita();
    renderKPIs();
    renderListaClientes();
    renderDetalleCliente();
  }

  // ====== AGENDA / TURNOS ======
  function marcarTurnoAtendido(id){
    const t = (appState.turnos || []).find(tt => tt.id === id);
    if(!t) return;
    t.atendido = true;
    saveState();
    renderAgenda();
  }

  function eliminarTurno(id){
    const ok = confirm('¬øEliminar este turno?');
    if(!ok) return;
    appState.turnos = appState.turnos || [];
    appState.turnos = appState.turnos.filter(t => t.id !== id);
    saveState();
    renderAgenda();
  }

  function enviarRecordatorioTurno(t){
    const paciente = t.pacienteId ? getPacienteById(t.pacienteId) : null;
    if(!paciente){
      alert('Este turno no est√° vinculado a un paciente del CRM.');
      return;
    }
    if(!paciente.whatsapp){
      alert('El paciente no tiene un n√∫mero de WhatsApp cargado en su ficha.');
      return;
    }
    const phone = sanitizePhone(paciente.whatsapp);
    if(!phone){
      alert('N√∫mero de WhatsApp inv√°lido en la ficha del paciente.');
      return;
    }
    const hoyIso = new Date().toISOString().slice(0,10);
    const esHoy = t.fecha === hoyIso;
    const fechaTxt = (esHoy ? 'hoy ' : 'el ') + formatDate(t.fecha);
    const med = appState.medico || {};
    const nombreMed = med.nombre || 'Lic. Silvia Molina';
    const esp = med.especialidad || 'Psic√≥loga';
    const lugar = 'Consultorio Savia ‚Äì Maip√∫';
    const msg = `Hola ${paciente.nombre || ''}, ¬øc√≥mo est√°s? Te recuerdo tu sesi√≥n de ${fechaTxt} a las ${t.hora || ''} con ${nombreMed} (${esp}), en ${lugar}. Si necesit√°s reprogramar o no pod√©s asistir, por favor avisame.`;
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  }

  function renderAgenda(){
    const hoyIso = new Date().toISOString().slice(0,10);
    const turnos = appState.turnos || [];

    const hoy = turnos
      .filter(t => t.fecha === hoyIso)
      .sort((a,b) => (a.hora || '').localeCompare(b.hora || ''));
    const proximos = turnos
      .filter(t => t.fecha > hoyIso)
      .sort((a,b) => (a.fecha + (a.hora || '')).localeCompare(b.fecha + (b.hora || '')));

    const listaHoyElem = document.getElementById('lista-turnos-hoy');
    const listaProxElem = document.getElementById('lista-turnos-prox');
    const emptyHoy = document.getElementById('agenda-empty-hoy');
    const emptyProx = document.getElementById('agenda-empty-prox');

    if(listaHoyElem && listaProxElem){
      listaHoyElem.innerHTML = '';
      listaProxElem.innerHTML = '';

      if(hoy.length === 0){
        emptyHoy.style.display = 'block';
      }else{
        emptyHoy.style.display = 'none';
      }
      if(proximos.length === 0){
        emptyProx.style.display = 'block';
      }else{
        emptyProx.style.display = 'none';
      }

      hoy.forEach(t => {
        const li = document.createElement('li');
        li.className = 'turno-item' + (t.atendido ? ' atendido' : '');

        const left = document.createElement('div');
        left.className = 'turno-left';

        const hora = document.createElement('div');
        hora.className = 'turno-hora';
        hora.textContent = t.hora || '--:--';

        const nombre = document.createElement('div');
        nombre.className = 'turno-nombre';
        nombre.textContent = t.nombrePaciente || '(Sin nombre)';

        const motivo = document.createElement('div');
        motivo.className = 'turno-motivo';
        motivo.textContent = t.motivo || '';

        left.appendChild(hora);
        left.appendChild(nombre);
        left.appendChild(motivo);

        const actions = document.createElement('div');
        actions.className = 'turno-actions';

        const btnWa = document.createElement('button');
        btnWa.className = 'turno-wa';
        btnWa.textContent = 'Recordar';
        btnWa.addEventListener('click', (ev) => {
          ev.stopPropagation();
          enviarRecordatorioTurno(t);
        });
        actions.appendChild(btnWa);

        const btnOk = document.createElement('button');
        btnOk.className = 'turno-ok';
        btnOk.textContent = t.atendido ? 'Atendido ‚úî' : 'Marcar atendido';
        if(t.atendido){
          btnOk.disabled = true;
        }else{
          btnOk.addEventListener('click', (ev) => {
            ev.stopPropagation();
            marcarTurnoAtendido(t.id);
          });
        }
        actions.appendChild(btnOk);

        const btnDel = document.createElement('button');
        btnDel.className = 'turno-del';
        btnDel.textContent = 'No vino (Eliminar)';
        btnDel.addEventListener('click', (ev) => {
          ev.stopPropagation();
          eliminarTurno(t.id);
        });
        actions.appendChild(btnDel);

        li.appendChild(left);
        li.appendChild(actions);
        listaHoyElem.appendChild(li);
      });

      proximos.forEach(t => {
        const li = document.createElement('li');
        li.className = 'turno-item';

        const left = document.createElement('div');
        left.className = 'turno-left';

        const fecha = document.createElement('div');
        fecha.className = 'turno-fecha-peq';
        fecha.textContent = formatDate(t.fecha);

        const hora = document.createElement('div');
        hora.className = 'turno-hora';
        hora.textContent = t.hora || '--:--';

        const nombre = document.createElement('div');
        nombre.className = 'turno-nombre';
        nombre.textContent = t.nombrePaciente || '(Sin nombre)';

        const motivo = document.createElement('div');
        motivo.className = 'turno-motivo';
        motivo.textContent = t.motivo || '';

        left.appendChild(fecha);
        left.appendChild(hora);
        left.appendChild(nombre);
        left.appendChild(motivo);

        const actions = document.createElement('div');
        actions.className = 'turno-actions';

        const btnWa = document.createElement('button');
        btnWa.className = 'turno-wa';
        btnWa.textContent = 'Recordar';
        btnWa.addEventListener('click', (ev) => {
          ev.stopPropagation();
          enviarRecordatorioTurno(t);
        });
        actions.appendChild(btnWa);

        const btnDel = document.createElement('button');
        btnDel.className = 'turno-del';
        btnDel.textContent = 'Eliminar';
        btnDel.addEventListener('click', (ev) => {
          ev.stopPropagation();
          eliminarTurno(t.id);
        });
        actions.appendChild(btnDel);

        li.appendChild(left);
        li.appendChild(actions);
        listaProxElem.appendChild(li);
      });
    }

    renderTurnosHome();
    renderKPIs();
  }

  function guardarTurno(e){
    e.preventDefault();
    const hoyIso = new Date().toISOString().slice(0,10);

    const fecha = document.getElementById('turno-fecha').value || hoyIso;
    const hora = document.getElementById('turno-hora').value || '';
    const pacienteIdSel = document.getElementById('turno-paciente-select').value;
    const motivo = document.getElementById('turno-motivo').value.trim();

    let nombrePaciente = '';
    if(pacienteIdSel){
      const p = getPacienteById(pacienteIdSel);
      if(p) nombrePaciente = p.nombre || '';
    }

    if(!nombrePaciente){
      nombrePaciente = '(Sin nombre)';
    }

    const turno = {
      id:'t_'+Date.now(),
      fecha,
      hora,
      pacienteId: pacienteIdSel || null,
      nombrePaciente,
      motivo,
      atendido:false
    };

    appState.turnos = appState.turnos || [];
    appState.turnos.push(turno);
    saveState();
    renderAgenda();
  }

  // ====== TURNOS HOME ======
  function renderTurnosHome(){
    const hoyIso = new Date().toISOString().slice(0,10);
    const turnos = (appState.turnos || [])
      .filter(t => t.fecha === hoyIso)
      .sort((a,b)=>(a.hora||'').localeCompare(b.hora||''));
    const lista = document.getElementById('lista-turnos-home');
    const empty = document.getElementById('agenda-empty-home');
    if(!lista || !empty) return;

    lista.innerHTML = '';
    if(turnos.length === 0){
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    turnos.forEach(t => {
      const li = document.createElement('li');
      li.className = 'turno-item' + (t.atendido ? ' atendido' : '');

      const left = document.createElement('div');
      left.className = 'turno-left';

      const hora = document.createElement('div');
      hora.className = 'turno-hora';
      hora.textContent = t.hora || '--:--';

      const nombre = document.createElement('div');
      nombre.className = 'turno-nombre';
      nombre.textContent = t.nombrePaciente || '(Sin nombre)';

      const motivo = document.createElement('div');
      motivo.className = 'turno-motivo';
      motivo.textContent = t.motivo || '';

      left.appendChild(hora);
      left.appendChild(nombre);
      left.appendChild(motivo);

      const actions = document.createElement('div');
      actions.className = 'turno-actions';

      const btnWa = document.createElement('button');
      btnWa.className = 'turno-wa';
      btnWa.textContent = 'Recordar';
      btnWa.addEventListener('click', (ev) => {
        ev.stopPropagation();
        enviarRecordatorioTurno(t);
      });
      actions.appendChild(btnWa);

      const btnOk = document.createElement('button');
      btnOk.className = 'turno-ok';
      btnOk.textContent = t.atendido ? 'Atendido ‚úî' : 'Marcar atendido';
      if(t.atendido){
        btnOk.disabled = true;
      }else{
        btnOk.addEventListener('click', (ev) => {
          ev.stopPropagation();
          marcarTurnoAtendido(t.id);
        });
      }
      actions.appendChild(btnOk);

      const btnDel = document.createElement('button');
      btnDel.className = 'turno-del';
      btnDel.textContent = 'No vino (Eliminar)';
      btnDel.addEventListener('click', (ev) => {
        ev.stopPropagation();
        eliminarTurno(t.id);
      });
      actions.appendChild(btnDel);

      li.appendChild(left);
      li.appendChild(actions);
      lista.appendChild(li);
    });
  }

  // ====== RECETAS / CERTIFICADOS ======
  function cargarDatosMedico(){
    const med = appState.medico || {};
    document.getElementById('medico-nombre').value = med.nombre || '';
    document.getElementById('medico-matricula').value = med.matricula || '';
    document.getElementById('medico-especialidad').value = med.especialidad || '';
  }

  function guardarDatosMedico(){
    appState.medico = appState.medico || {};
    appState.medico.nombre = document.getElementById('medico-nombre').value.trim();
    appState.medico.matricula = document.getElementById('medico-matricula').value.trim();
    appState.medico.especialidad = document.getElementById('medico-especialidad').value.trim();
    saveState();
  }

  function renderDocPacienteOpciones(){
    const select = document.getElementById('doc-paciente-select');
    const selectTurno = document.getElementById('turno-paciente-select');
    if(!select || !selectTurno) return;
    const pacientes = appState.clientes || [];
    const currentDoc = select.value;
    const currentTurno = selectTurno.value;

    select.innerHTML = '<option value="">Seleccionar paciente...</option>';
    selectTurno.innerHTML = '<option value="">Seleccionar paciente...</option>';

    pacientes.forEach(c => {
      const opt1 = document.createElement('option');
      opt1.value = c.id;
      opt1.textContent = c.nombre || '(Sin nombre)';
      select.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = c.id;
      opt2.textContent = c.nombre || '(Sin nombre)';
      selectTurno.appendChild(opt2);
    });

    if(currentDoc) select.value = currentDoc;
    if(currentTurno) selectTurno.value = currentTurno;
  }

  function getDocData(){
    const tipo = document.getElementById('doc-tipo').value || 'receta';
    const medNombre = document.getElementById('medico-nombre').value.trim();
    const medMat = document.getElementById('medico-matricula').value.trim();
    const medEsp = document.getElementById('medico-especialidad').value.trim();
    const pacienteNombre = document.getElementById('doc-paciente-nombre').value.trim();
    const obraSocial = document.getElementById('doc-obra-social').value.trim();
    const cuerpo = document.getElementById('doc-cuerpo').value.trim();
    const hoy = new Date();
    const fechaStr = hoy.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
    const fechaIso = hoy.toISOString().slice(0,10);
    return {tipo, medNombre, medMat, medEsp, pacienteNombre, obraSocial, cuerpo, fechaStr, fechaIso};
  }

  function buildDocText(){
    const d = getDocData();

    let header = '';
    if(d.medNombre){
      header += d.medNombre;
      if(d.medEsp) header += ' ‚Äì ' + d.medEsp;
      header += '\n';
    }
    if(d.medMat) header += 'M.P.: ' + d.medMat + '\n';
    header += '\nFecha: ' + d.fechaStr + '\n\n';

    let pacienteStr = '';
    if(d.pacienteNombre || d.obraSocial){
      pacienteStr += 'Paciente: ' + (d.pacienteNombre || '________________') + '\n';
      if(d.obraSocial){
        pacienteStr += 'Obra social / cobertura: ' + d.obraSocial + '\n';
      }
      pacienteStr += '\n';
    }

    let cuerpoLabel = d.tipo === 'certificado' ? 'Certifico que:\n' : 'Indicaci√≥n / Pedido:\n';
    let cuerpoStr = d.cuerpo ? d.cuerpo + '\n\n' : '____________________________________\n\n';

    let firma = '_______________________________\nFirma y sello profesional\n';

    return header + pacienteStr + cuerpoLabel + cuerpoStr + firma;
  }

  function updateDocPreview(){
    const preview = document.getElementById('doc-preview');
    if(!preview) return;
    preview.textContent = buildDocText();
  }

  function renderDocHistorial(){
    const lista = document.getElementById('doc-historial');
    const empty = document.getElementById('doc-empty');
    if(!lista || !empty) return;

    const docs = appState.documentos || [];
    lista.innerHTML = '';

    if(docs.length === 0){
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    docs.forEach(d => {
      const li = document.createElement('li');
      li.className = 'visita-item';

      const left = document.createElement('div');
      left.className = 'visita-left';

      const linea1 = document.createElement('div');
      linea1.textContent = formatDate(d.fecha) + ' ‚Äì ' + (d.tipo === 'certificado' ? 'Certificado' : 'Receta / Pedido');

      const linea2 = document.createElement('div');
      linea2.className = 'visita-nota';
      const pac = d.pacienteNombre ? d.pacienteNombre : '(Sin paciente)';
      const os = d.obraSocial ? ' ¬∑ ' + d.obraSocial : '';
      linea2.textContent = pac + os;

      left.appendChild(linea1);
      left.appendChild(linea2);

      const detalle = document.createElement('div');
      detalle.className = 'visita-monto';
      detalle.textContent = (d.resumen || '').slice(0,50) + (d.resumen && d.resumen.length>50 ? '...' : '');

      li.appendChild(left);
      li.appendChild(detalle);
      lista.appendChild(li);
    });
  }

  function agregarDocumentoHistorial(data, texto){
    appState.documentos = appState.documentos || [];
    appState.documentos.unshift({
      id:'d_'+Date.now(),
      tipo:data.tipo,
      fecha:data.fechaIso,
      pacienteNombre: data.pacienteNombre || '',
      obraSocial: data.obraSocial || '',
      resumen: texto || ''
    });
    appState.documentos = appState.documentos.slice(0,20);
    saveState();
    renderDocHistorial();
  }

  // ===== FIRMA DIGITAL =====
  function initFirmaCanvas(){
    firmaCanvas = document.getElementById('firma-canvas');
    if(!firmaCanvas) return;
    firmaCtx = firmaCanvas.getContext('2d');

    firmaCanvas.width = 400;
    firmaCanvas.height = 150;
    firmaCtx.fillStyle = '#ffffff';
    firmaCtx.fillRect(0,0,firmaCanvas.width,firmaCanvas.height);

    const med = appState.medico || {};
    if(med.firmaDataUrl){
      const img = new Image();
      img.onload = () => {
        firmaCtx.drawImage(img, 0,0,firmaCanvas.width,firmaCanvas.height);
      };
      img.src = med.firmaDataUrl;
    }

    function getPos(e){
      const rect = firmaCanvas.getBoundingClientRect();
      if(e.touches && e.touches.length>0){
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }else{
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }
    }

    function startDraw(e){
      e.preventDefault();
      firmaDrawing = true;
      const pos = getPos(e);
      firmaLastX = pos.x;
      firmaLastY = pos.y;
    }
    function draw(e){
      if(!firmaDrawing) return;
      e.preventDefault();
      const pos = getPos(e);
      firmaCtx.beginPath();
      firmaCtx.moveTo(firmaLastX,firmaLastY);
      firmaCtx.lineTo(pos.x,pos.y);
      firmaCtx.strokeStyle = '#0f172a';
      firmaCtx.lineWidth = 2;
      firmaCtx.lineCap = 'round';
      firmaCtx.stroke();
      firmaLastX = pos.x;
      firmaLastY = pos.y;
    }
    function endDraw(e){
      if(!firmaDrawing) return;
      e.preventDefault();
      firmaDrawing = false;
    }

    firmaCanvas.addEventListener('mousedown', startDraw);
    firmaCanvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', endDraw);
    firmaCanvas.addEventListener('touchstart', startDraw);
    firmaCanvas.addEventListener('touchmove', draw);
    firmaCanvas.addEventListener('touchend', endDraw);
  }

  function limpiarFirmaCanvas(){
    if(!firmaCtx || !firmaCanvas) return;
    firmaCtx.fillStyle = '#ffffff';
    firmaCtx.fillRect(0,0,firmaCanvas.width,firmaCanvas.height);
  }

  // ====== ARRANQUE ======
  document.addEventListener('DOMContentLoaded', () => {
    loadState();
    renderKPIs();
    renderListaClientes();
    renderDetalleCliente();
    renderAgenda();
    cargarDatosMedico();
    renderDocPacienteOpciones();
    renderDocHistorial();
    updateDocPreview();
    initFirmaCanvas();

    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const sections = {
      inicio: document.getElementById('section-inicio'),
      turnos: document.getElementById('section-turnos'),
      recetas: document.getElementById('section-recetas'),
      dashboard: document.getElementById('section-dashboard')
    };
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.section;
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.keys(sections).forEach(key => {
          if(sections[key]){
            sections[key].style.display = (key === target ? 'block' : 'none');
          }
        });
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });

    // Bot√≥n nuevo paciente
    document.getElementById('btn-nuevo-cliente').addEventListener('click', () => {
      limpiarFormularioCliente();
      openModalCliente('nuevo');
    });
    document.getElementById('cerrar-modal-cliente').addEventListener('click', closeModalCliente);
    document.getElementById('cancelar-modal-cliente').addEventListener('click', closeModalCliente);

    // Guardar paciente
    document.getElementById('form-cliente').addEventListener('submit', e => {
      e.preventDefault();
      const id = document.getElementById('cliente-id').value;
      const nombre = document.getElementById('cliente-nombre').value.trim();
      const servicioPrincipal = document.getElementById('cliente-servicio').value.trim();
      const cobertura = document.getElementById('cliente-cobertura').value.trim();
      const whatsapp = document.getElementById('cliente-whatsapp').value.trim();
      const email = document.getElementById('cliente-email').value.trim();
      const notas = document.getElementById('cliente-notas').value.trim();

      if(!nombre){
        alert('El nombre es obligatorio.');
        return;
      }

      if(id){
        const cliente = (appState.clientes || []).find(c => c.id === id);
        if(cliente){
          cliente.nombre = nombre;
          cliente.servicioPrincipal = servicioPrincipal;
          cliente.cobertura = cobertura;
          cliente.whatsapp = whatsapp;
          cliente.email = email;
          cliente.notas = notas;
        }
        selectedClientId = id;
      }else{
        const hoyIso = new Date().toISOString().slice(0,10);
        const nuevo = {
          id:'c_'+Date.now(),
          nombre,
          servicioPrincipal,
          cobertura,
          whatsapp,
          email,
          fechaAlta:hoyIso,
          ultimaVisita:null,
          notas,
          visitas:[]
        };
        appState.clientes = appState.clientes || [];
        appState.clientes.push(nuevo);
        selectedClientId = nuevo.id;
      }

      saveState();
      closeModalCliente();
      renderKPIs();
      renderListaClientes();
      renderDetalleCliente();
      renderAgenda();
    });

    // Bot√≥n editar paciente
    document.getElementById('btn-editar-cliente').addEventListener('click', () => {
      if(!selectedClientId) return;
      const cliente = (appState.clientes || []).find(c => c.id === selectedClientId);
      if(!cliente) return;
      cargarFormularioCliente(cliente);
      openModalCliente('editar');
    });

    // Bot√≥n eliminar paciente
    document.getElementById('btn-eliminar-cliente').addEventListener('click', eliminarCliente);

    // Filtros
    document.querySelectorAll('.btn-outline[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.btn-outline[data-filter]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderListaClientes();
      });
    });

    // Buscador
    document.getElementById('buscador-clientes').addEventListener('input', e => {
      currentSearch = e.target.value;
      renderListaClientes();
    });

    // WhatsApp desde ficha
    document.getElementById('btn-whatsapp').addEventListener('click', () => {
      if(!selectedClientId) return;
      const cliente = (appState.clientes || []).find(c => c.id === selectedClientId);
      if(!cliente || !cliente.whatsapp){
        alert('Este paciente no tiene un n√∫mero de WhatsApp cargado.');
        return;
      }
      const phone = sanitizePhone(cliente.whatsapp);
      if(!phone){
        alert('N√∫mero de WhatsApp inv√°lido.');
        return;
      }
      const msg = `Hola ${cliente.nombre || ''}, ¬øc√≥mo est√°s? Te escribo para coordinar tu pr√≥xima consulta.`;
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank');
    });

    // Registrar consulta (aunque el bloque del detalle est√° oculto visualmente)
    document.getElementById('btn-nueva-visita').addEventListener('click', openModalVisita);
    document.getElementById('cerrar-modal-visita').addEventListener('click', closeModalVisita);
    document.getElementById('cancelar-modal-visita').addEventListener('click', closeModalVisita);
    document.getElementById('form-visita').addEventListener('submit', guardarVisita);

    // Agenda
    document.getElementById('form-turno').addEventListener('submit', guardarTurno);

    // Borrar datos demo
    document.getElementById('btn-reset-demo').addEventListener('click', () => {
      const ok = confirm('Esto borrar√° todos los datos guardados en este navegador para Savia Silvia. ¬øQuer√©s continuar?');
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      seedDemoData();
      loadState();
      selectedClientId = null;
      renderKPIs();
      renderListaClientes();
      renderDetalleCliente();
      renderAgenda();
      cargarDatosMedico();
      renderDocPacienteOpciones();
      renderDocHistorial();
      updateDocPreview();
      initFirmaCanvas();
    });

    // Cerrar modales clickeando fuera
    modalClienteBackdrop.addEventListener('click', e => {
      if(e.target === modalClienteBackdrop) closeModalCliente();
    });
    modalVisitaBackdrop.addEventListener('click', e => {
      if(e.target === modalVisitaBackdrop) closeModalVisita();
    });

    // Datos profesional: guardar cuando cambia
    ['medico-nombre','medico-matricula','medico-especialidad'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => {
        guardarDatosMedico();
        updateDocPreview();
      });
    });

    // Doc: cambio de paciente en select
    document.getElementById('doc-paciente-select').addEventListener('change', () => {
      const id = document.getElementById('doc-paciente-select').value;
      const pacienteField = document.getElementById('doc-paciente-nombre');
      const whatsappField = document.getElementById('doc-whatsapp');
      const obraField = document.getElementById('doc-obra-social');
      if(!id){
        updateDocPreview();
        return;
      }
      const p = getPacienteById(id);
      if(p){
        if(!pacienteField.value) pacienteField.value = p.nombre || '';
        if(!whatsappField.value) whatsappField.value = p.whatsapp || '';
        if(!obraField.value && p.cobertura) obraField.value = p.cobertura;
      }
      updateDocPreview();
    });

    // Cualquier cambio en el documento actualiza vista previa
    ['doc-tipo','doc-paciente-nombre','doc-obra-social','doc-whatsapp','doc-cuerpo'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', updateDocPreview);
    });

    // Firma digital botones
    document.getElementById('btn-firma-limpiar').addEventListener('click', () => {
      limpiarFirmaCanvas();
      if(appState.medico){
        appState.medico.firmaDataUrl = '';
        saveState();
      }
    });
    document.getElementById('btn-firma-guardar').addEventListener('click', () => {
      if(!firmaCanvas) return;
      const dataUrl = firmaCanvas.toDataURL('image/png');
      appState.medico = appState.medico || {};
      appState.medico.firmaDataUrl = dataUrl;
      saveState();
      alert('Firma guardada. Se usar√° autom√°ticamente en los pr√≥ximos PDF.');
    });

    // Generar PDF
    document.getElementById('btn-doc-pdf').addEventListener('click', () => {
      const data = getDocData();
      if(!data.medNombre){
        alert('Complet√° al menos el nombre del profesional.');
        return;
      }
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){
        alert('No se pudo cargar el generador de PDF. Revis√° tu conexi√≥n.');
        return;
      }
      const doc = new jsPDF({unit:'mm', format:'a4'});
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      // Header Savia
      doc.setFillColor(20,184,166);
      doc.rect(0,0,pageWidth,35,'F');

      doc.setTextColor(255,255,255);
      doc.setFont('helvetica','bold');
      doc.setFontSize(16);
      doc.text(data.medNombre || 'Lic. Silvia Molina', 20, 18);

      doc.setFontSize(11);
      doc.setFont('helvetica','normal');
      const espLine = data.medEsp ? data.medEsp : 'Psic√≥loga';
      let headerLine2 = espLine;
      if(data.medMat) headerLine2 += ' ¬∑ MP ' + data.medMat;
      doc.text(headerLine2, 20, 24);

      doc.setFontSize(10);
      doc.text('Consultorio Savia ¬∑ Maip√∫ ‚Äì Mendoza', 20, 30);

      // "Logo" Savia simple
      doc.setDrawColor(255,255,255);
      doc.setLineWidth(0.5);
      const boxW = 26, boxH = 22;
      const boxX = pageWidth - boxW - 15, boxY = 7;
      doc.roundedRect(boxX, boxY, boxW, boxH, 3,3,'S');
      doc.setFontSize(11);
      doc.text('Savia', boxX + boxW/2, boxY + boxH/2 + 2, {align:'center'});

      // Contenido
      doc.setTextColor(0,0,0);
      doc.setFont('helvetica','normal');
      doc.setFontSize(11);

      let y = 45;
      doc.text('Paciente: ' + (data.pacienteNombre || '________________________'), 20, y);
      y += 6;
      doc.text('Obra social / cobertura: ' + (data.obraSocial || '________________'), 20, y);
      y += 6;
      doc.text('Fecha: ' + data.fechaStr, 20, y);

      y += 10;
      doc.setFontSize(12);
      const titulo = data.tipo === 'certificado' ? 'Certifico que:' : 'Indicaci√≥n / Pedido:';
      doc.text(titulo, 20, y);

      y += 8;
      doc.setFontSize(11);
      const textoCuerpo = data.cuerpo || '__________________________________________';
      const maxWidth = pageWidth - 40;
      const lineas = doc.splitTextToSize(textoCuerpo, maxWidth);
      doc.text(lineas, 20, y);
      const cuerpoHeight = lineas.length * 6;
      y += cuerpoHeight + 10;

      // Firma: parte baja derecha
      const firmaYBase = pageHeight - 40;
      const firmaData = (appState.medico || {}).firmaDataUrl;

      if(firmaData){
        try{
          const imgProps = doc.getImageProperties(firmaData);
          const firmaWidth = 40;
          const firmaHeight = (imgProps.height * firmaWidth) / imgProps.width;
          const firmaX = pageWidth - firmaWidth - 20;
          doc.addImage(firmaData,'PNG',firmaX,firmaYBase,firmaWidth,firmaHeight);
          doc.setFontSize(11);
          doc.setTextColor(0,0,0);
          doc.text(data.medNombre || 'Lic. Silvia Molina', firmaX, firmaYBase + firmaHeight + 6);
          let linea = '';
          if(data.medEsp) linea += data.medEsp;
          if(data.medMat){
            if(linea) linea += ' ‚Äì ';
            linea += 'MP ' + data.medMat;
          }
          if(!linea) linea = 'Psic√≥loga';
          doc.setFontSize(10);
          doc.text(linea, firmaX, firmaYBase + firmaHeight + 12);
        }catch(e){
          doc.setFontSize(11);
          doc.text('_______________________________', 20, firmaYBase);
          doc.text('Firma y sello profesional', 20, firmaYBase+6);
        }
      }else{
        doc.setFontSize(11);
        doc.text('_______________________________', 20, firmaYBase);
        doc.text('Firma y sello profesional', 20, firmaYBase+6);
      }

      // Footer Savia
      doc.setFontSize(9);
      doc.setTextColor(148,163,184);
      doc.text('Generado con Savia ‚Äì CRM para profesionales de la salud', 20, pageHeight-10);

      const pacienteFile = (data.pacienteNombre || 'paciente').replace(/\s+/g,'_');
      const fileName = (data.tipo === 'certificado' ? 'certificado_' : 'receta_') +
                       pacienteFile + '_' + data.fechaIso + '.pdf';

      doc.save(fileName);

      const textoCompleto = buildDocText();
      agregarDocumentoHistorial(data, textoCompleto);

      alert('PDF generado. Buscalo en tu carpeta de descargas y adjuntalo en WhatsApp o email.');
    });

    // Copiar texto
    document.getElementById('btn-doc-copiar').addEventListener('click', async () => {
      const texto = buildDocText();
      try{
        await navigator.clipboard.writeText(texto);
        alert('Texto copiado. Pegalo en WhatsApp, mail o donde necesites.');
      }catch(e){
        alert('No se pudo copiar autom√°ticamente. Seleccion√° el texto de la vista previa y copialo.');
      }
    });

    // Abrir WhatsApp desde documento
    document.getElementById('btn-doc-whatsapp').addEventListener('click', () => {
      const phoneInput = document.getElementById('doc-whatsapp').value.trim();
      if(!phoneInput){
        alert('Carg√° el WhatsApp del paciente para abrir el chat.');
        return;
      }
      const phone = sanitizePhone(phoneInput);
      if(!phone){
        alert('N√∫mero de WhatsApp inv√°lido.');
        return;
      }
      const data = getDocData();
      const tipoTxt = data.tipo === 'certificado' ? 'certificado m√©dico' : 'receta / pedido';
      const msg = `Hola, te env√≠o tu ${tipoTxt}. Te adjunto el PDF en el siguiente mensaje.`;
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank');
    });

    // Limpiar documento (Salir)
    document.getElementById('btn-doc-limpiar').addEventListener('click', () => {
      document.getElementById('doc-tipo').value = 'receta';
      document.getElementById('doc-paciente-select').value = '';
      document.getElementById('doc-paciente-nombre').value = '';
      document.getElementById('doc-obra-social').value = '';
      document.getElementById('doc-whatsapp').value = '';
      document.getElementById('doc-cuerpo').value = '';
      updateDocPreview();
    });
  });
</script>
</body>
</html>
